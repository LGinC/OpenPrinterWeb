@page "/print"
@using OpenPrinterWeb.Services
@using Microsoft.AspNetCore.SignalR.Client
@inject IFileUploadService FileUploadService
@inject IPrintService PrintService
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>Print Manager</PageTitle>

<h1>Print Manager</h1>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                Upload & Print
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="formFile" class="form-label">Select PDF or Image to print</label>
                    <InputFile OnChange="@LoadFiles" class="form-control" id="formFile" accept=".pdf,.jpg,.jpeg,.png" />
                </div>
                
                @if (isUploading)
                {
                    <div class="progress mb-3">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%">Uploading...</div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(statusMessage))
                {
                    <div class="alert @statusClass" role="alert">
                        @statusMessage
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                Printer Status (Jobs)
            </div>
            <div class="card-body">
                 @if (jobs == null)
                {
                    <p><em>Waiting for updates...</em></p>
                }
                else if (jobs.Length == 0)
                {
                    <p>No active jobs.</p>
                }
                else
                {
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Job Name</th>
                                <th>State</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var job in jobs)
                            {
                                <tr>
                                    <td>@job.Id</td>
                                    <td>@job.Name</td>
                                    <td>
                                        <span class="badge @GetBadgeClass(job.State)">@job.State</span>
                                    </td>
                                    <td>@job.User</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                Available Printers
            </div>
            <div class="card-body">
                @if (printers == null)
                {
                    <p><em>Loading printers...</em></p>
                }
                else if (printers.Length == 0)
                {
                    <p>No printers found.</p>
                }
                else
                {
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Default</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var printer in printers)
                            {
                                <tr>
                                    <td>@printer.Name</td>
                                    <td>@printer.Description</td>
                                    <td>@printer.State</td>
                                    <td>
                                        @if (printer.IsDefault)
                                        {
                                            <span class="badge bg-primary">Default</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private bool isUploading = false;
    private string statusMessage = "";
    private string statusClass = "alert-info";
    private JobStatusInfo[]? jobs;
    private PrinterInfo[]? printers;
    private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/printerhub"))
            .Build();

        hubConnection.On<JobStatusInfo[]>("JobUpdate", (updatedJobs) =>
        {
            jobs = updatedJobs;
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
        
        // Initial fetch
        jobs = await PrintService.GetJobsAsync();
        printers = await PrintService.GetPrintersAsync();
    }

    private async Task LoadFiles(InputFileChangeEventArgs e)
    {
        isUploading = true;
        statusMessage = "";
        StateHasChanged();

        try
        {
            foreach (var file in e.GetMultipleFiles(1))
            {
                // Upload to server temp
                using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB max
                var filePath = await FileUploadService.UploadFileAsync(stream, file.Name);

                // Send to print
                // We need to re-open the file to send to print service or pass the stream directly if PrintService supports seeking?
                // CupsPrintService consumes the stream. Let's read from the saved file.
                
                using var fileStream = File.OpenRead(filePath);
                var success = await PrintService.PrintDocumentAsync(file.Name, fileStream);

                if (success)
                {
                    statusMessage = $"Successfully sent {file.Name} to printer.";
                    statusClass = "alert-success";
                }
                else
                {
                    statusMessage = $"Failed to print {file.Name}. Check server logs.";
                    statusClass = "alert-danger";
                }
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            statusClass = "alert-danger";
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }

    private string GetBadgeClass(string state)
    {
        return state.ToLower() switch
        {
             "completed" => "bg-success",
             "processing" => "bg-primary",
             "pending" => "bg-warning text-dark",
             "pendingheld" => "bg-warning text-dark",
             "stopped" => "bg-danger",
             "canceled" => "bg-secondary",
             _ => "bg-secondary"
        };
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
