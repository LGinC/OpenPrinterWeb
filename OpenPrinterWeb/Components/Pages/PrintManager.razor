@page "/"
@attribute [Authorize]
@using OpenPrinterWeb.Services
@using Microsoft.Extensions.Localization
@using Microsoft.AspNetCore.SignalR.Client
@inject IFileUploadService FileUploadService
@inject IPrintService PrintService
@inject NavigationManager Navigation
@inject IStringLocalizer<SharedResource> Localizer
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>@Localizer["PrintManagerTitle"]</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">@Localizer["PrintManagerTitle"]</MudText>

<MudGrid>
    <MudItem xs="12" md="7">
        <MudCard Elevation="2" Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@Localizer["UploadAndPrintHeader"]</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <div class="mb-4">
                    <MudFileUpload T="IBrowserFile" OnFilesChanged="HandleFileSelection" Accept=".pdf,.jpg,.jpeg,.png">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.CloudUpload">
                                @Localizer["SelectPdfOrImageButton"]
                            </MudButton>
                        </ActivatorContent>
                    </MudFileUpload>
                </div>
                
                @if (isUploading)
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
                }

                @if (!string.IsNullOrEmpty(selectedFileUrl))
                {
                    <MudText Typo="Typo.subtitle1" Class="mt-4 mb-2">@Localizer["PreviewLabel"]</MudText>
                    <div class="preview-background d-flex justify-content-center align-items-center bg-secondary p-4 rounded mb-4" style="min-height: 450px; overflow: hidden;">
                        <div class="preview-paper bg-white shadow-lg" style="@GetPaperStyle()">
                            <div class="preview-content h-100 w-100 d-flex justify-content-center align-items-center" style="@GetContentFilterStyle()">
                                <div style="@GetRotationWrapperStyle()">
                                    @if (selectedFileUrl.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <embed src="@($"{selectedFileUrl}#toolbar=0&navpanes=0&scrollbar=0&view=FitH")" type="application/pdf" style="width: 100%; height: 100%; display: block;" />
                                    }
                                    else
                                    {
                                        <img src="@selectedFileUrl" alt="Preview" style="width: 100%; height: 100%; object-fit: contain; display: block;" />
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <MudCard Elevation="0" Outlined="true" Class="mb-4 pa-4 bg-light">
                        <MudText Typo="Typo.subtitle2" Class="mb-4">@Localizer["PrinterAndOptionsLabel"]</MudText>
                        <MudGrid Spacing="3">
                        <MudItem xs="12">
                                <MudSelect T="string" Label="@Localizer["SelectPrinterLabel"]" @bind-Value="selectedPrinterUri" Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                                    @if (printers != null)
                                    {
                                        @foreach (var p in printers)
                                        {
                                            <MudSelectItem Value="@p.Uri">@p.Name (@p.Description)</MudSelectItem>
                                        }
                                    }
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudSelect T="PrintColorMode" Label="@Localizer["ColorModeLabel"]" @bind-Value="printOptions.ColorMode" Variant="Variant.Outlined">
                                    <MudSelectItem Value="@PrintColorMode.Color">@Localizer["ColorModeColor"]</MudSelectItem>
                                    <MudSelectItem Value="@PrintColorMode.Monochrome">@Localizer["ColorModeBw"]</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudSelect T="PrintOrientation" Label="@Localizer["OrientationLabel"]" @bind-Value="printOptions.Orientation" Variant="Variant.Outlined">
                                    <MudSelectItem Value="@PrintOrientation.Portrait">@Localizer["OrientationPortrait"]</MudSelectItem>
                                    <MudSelectItem Value="@PrintOrientation.Landscape">@Localizer["OrientationLandscape"]</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudNumericField @bind-Value="printOptions.Copies" Label="@Localizer["CopiesLabel"]" Variant="Variant.Outlined" Min="1" />
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField @bind-Value="printOptions.PageRange" Label="@Localizer["PageRangeLabel"]" Variant="Variant.Outlined" Placeholder="e.g. 1-5, 8" />
                            </MudItem>
                        </MudGrid>
                    </MudCard>

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" OnClick="PrintFile" Disabled="@isPrinting" Size="Size.Large">
                        @if (isPrinting)
                        {
                            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                            <MudText Class="ms-2">@Localizer["PrintingButton"]</MudText>
                        }
                        else
                        {
                            <MudText>@Localizer["PrintNowButton"]</MudText>
                        }
                    </MudButton>
                }

                @if (!string.IsNullOrEmpty(statusMessage))
                {
                    <MudAlert Severity="@GetSeverity()" Variant="Variant.Filled" Class="mt-4">@statusMessage</MudAlert>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>

    <MudItem xs="12" md="5">
        <MudCard Elevation="2">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@Localizer["PrinterStatusHeader"]</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                 @if (jobs == null)
                {
                    <MudText><em>@Localizer["WaitingForUpdates"]</em></MudText>
                }
                else if (jobs.Length == 0)
                {
                    <MudText>@Localizer["NoActiveJobs"]</MudText>
                }
                else
                {
                    <MudSimpleTable Style="overflow-x: auto;" Dense="true" Striped="true">
                        <thead>
                            <tr>
                                <th>@Localizer["JobIdHeader"]</th>
                                <th>@Localizer["JobNameHeader"]</th>
                                <th>@Localizer["JobStateHeader"]</th>
                                <th>@Localizer["JobUserHeader"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var job in jobs)
                            {
                                <tr>
                                    <td>@job.Id</td>
                                    <td>@job.Name</td>
                                    <td>
                                        <MudChip T="string" Color="@GetChipColor(job.State)" Size="Size.Small">@job.State</MudChip>
                                    </td>
                                    <td>@job.User</td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
            </MudCardContent>
        </MudCard>

        <MudCard Elevation="2" Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">@Localizer["AvailablePrintersHeader"]</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (printers == null)
                {
                    <MudText><em>@Localizer["LoadingPrinters"]</em></MudText>
                }
                else if (printers.Length == 0)
                {
                    <MudText>@Localizer["NoPrintersFound"]</MudText>
                }
                else
                {
                    <MudSimpleTable Style="overflow-x: auto;" Hover="true">
                        <thead>
                            <tr>
                                <th>@Localizer["PrinterNameHeader"]</th>
                                <th>@Localizer["PrinterStatusHeaderTable"]</th>
                                <th>@Localizer["PrinterDefaultHeader"]</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var printer in printers)
                            {
                                <tr style="cursor: pointer" @onclick="() => selectedPrinterUri = printer.Uri" class="@(selectedPrinterUri == printer.Uri ? "selected-row" : "")">
                                    <td>
                                        <MudText Typo="Typo.body2"><b>@printer.Name</b></MudText>
                                        <MudText Typo="Typo.caption">@printer.Description</MudText>
                                    </td>
                                    <td>@printer.State</td>
                                    <td>
                                        @if (printer.IsDefault)
                                        {
                                            <MudChip T="string" Color="Color.Primary" Size="Size.Small">@Localizer["PrinterDefaultHeader"]</MudChip>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </MudSimpleTable>
                }
            </MudCardContent>
        </MudCard>
    </MudItem>
</MudGrid>

<style>
    .selected-row {
        background-color: var(--mud-palette-action-default-hover) !important;
    }
    .bg-light {
        background-color: var(--mud-palette-background-grey) !important;
    }
</style>

@code {
    private bool isUploading = false;
    private bool isPrinting = false;
    private string statusMessage = "";
    private string statusClass = "alert-info";
    private string? selectedFileUrl;
    private string? selectedFilePath;
    private string? selectedFileName;
    private string? selectedPrinterUri;
    private PrintOptions printOptions = new();
    private JobStatusInfo[]? jobs;
    private PrinterInfo[]? printers;
    private HubConnection? hubConnection;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            
            hubConnection = new HubConnectionBuilder()
                .WithUrl(Navigation.ToAbsoluteUri("/printerhub"), options => {
                    options.AccessTokenProvider = () => Task.FromResult<string?>(token);
                })
                .Build();

            hubConnection.On<JobStatusInfo[]>("JobUpdate", (updatedJobs) =>
            {
                jobs = updatedJobs;
                InvokeAsync(StateHasChanged);
            });

            await hubConnection.StartAsync();

            // Initial fetch
            jobs = await PrintService.GetJobsAsync();
            printers = await PrintService.GetPrintersAsync();
            
            if (printers != null && printers.Any())
            {
                selectedPrinterUri = printers.First().Uri;
            }
            StateHasChanged();
        }
    }

    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        isUploading = true;
        statusMessage = Localizer["UploadingMessage"];
        statusClass = "alert-info";
        selectedFileUrl = null;
        selectedFilePath = null;
        StateHasChanged();

        try
        {
            var file = e.File;
            if (file != null)
            {
                using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB max
                selectedFilePath = await FileUploadService.UploadFileAsync(stream, file.Name);
                selectedFileName = file.Name;
                
                var fileName = Path.GetFileName(selectedFilePath);
                selectedFileUrl = $"uploads/{fileName}";
                statusMessage = string.Format(Localizer["FileReadyMessage"], file.Name);
                statusClass = "alert-success";
                Console.WriteLine($"DEBUG: File selected and prepared: {selectedFileUrl}");
            }
        }
        catch (Exception ex)
        {
            statusMessage = string.Format(Localizer["UploadErrorMessage"], ex.Message);
            statusClass = "alert-danger";
            Console.WriteLine($"DEBUG: Upload error: {ex.Message}");
        }
        finally
        {
            isUploading = false;
            StateHasChanged();
        }
    }

    private async Task PrintFile()
    {
        if (string.IsNullOrEmpty(selectedFilePath) || string.IsNullOrEmpty(selectedFileName)) return;

        isPrinting = true;
        statusMessage = Localizer["SendingToPrinterMessage"];
        statusClass = "alert-info";
        StateHasChanged();

        try
        {
            using var fileStream = File.OpenRead(selectedFilePath);
            var success = await PrintService.PrintDocumentAsync(selectedFileName, fileStream, selectedPrinterUri, printOptions);

            if (success)
            {
                statusMessage = string.Format(Localizer["PrintSuccessMessage"], selectedFileName);
                statusClass = "alert-success";
                // Clear selection after print? 
                // selectedFileUrl = null;
            }
            else
            {
                statusMessage = string.Format(Localizer["PrintFailureMessage"], selectedFileName);
                statusClass = "alert-danger";
            }
        }
        catch (Exception ex)
        {
            statusMessage = string.Format(Localizer["GenericErrorMessage"], ex.Message);
            statusClass = "alert-danger";
        }
        finally
        {
            isPrinting = false;
            StateHasChanged();
        }
    }

    private Severity GetSeverity()
    {
        return statusClass switch
        {
            "alert-success" => Severity.Success,
            "alert-danger" => Severity.Error,
            "alert-warning" => Severity.Warning,
            _ => Severity.Info
        };
    }

    private Color GetChipColor(string state)
    {
        return state.ToLower() switch
        {
             "completed" => Color.Success,
             "processing" => Color.Primary,
             "pending" => Color.Warning,
             "pendingheld" => Color.Warning,
             "stopped" => Color.Error,
             "canceled" => Color.Default,
             _ => Color.Default
        };
    }

    private string GetPaperStyle()
    {
        bool isLandscape = printOptions.Orientation == PrintOrientation.Landscape;
        // Using common aspect ratios to represent A4 paper
        string width = isLandscape ? "450px" : "320px";
        string height = isLandscape ? "320px" : "450px";
        return $"width: {width}; height: {height}; transition: all 0.3s ease-in-out; position: relative; overflow: hidden;";
    }

    private string GetContentFilterStyle()
    {
        if (printOptions.ColorMode == PrintColorMode.Monochrome)
        {
            return "filter: grayscale(100%);";
        }
        return "";
    }

    private string GetRotationWrapperStyle()
    {
        bool isLandscape = printOptions.Orientation == PrintOrientation.Landscape;
        var styles = new List<string> { "transition: all 0.3s ease-in-out", "display: block" };
        
        if (isLandscape)
        {
            // Use portrait dimensions for the content before rotation
            styles.Add("width: 320px");
            styles.Add("height: 450px");
            styles.Add("transform: rotate(90deg)");
            styles.Add("transform-origin: center");
        }
        else
        {
            styles.Add("width: 100%");
            styles.Add("height: 100%");
        }
        
        return string.Join("; ", styles);
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
